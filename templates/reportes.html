<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Reporte de Impresiones - Subir .csv</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="{{ url_for('static', filename='css/estilos.css') }}" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
    <div class="card p-4 shadow-sm" style="width: 100%; max-width: 500px;">
        <div class="titulo-principal mb-4">
            <i class="bi bi-file-earmark-spreadsheet"></i>
            <h1>Subir archivo CSV</h1>
        </div>

        <div class="alert alert-warning mb-4">
            <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                    <i class="bi bi-exclamation-triangle"></i> Nota: Asegúrese de que el CSV tenga los encabezados correctos
                </h6>
                <button class="btn btn-sm btn-outline-warning" type="button" data-bs-toggle="collapse" data-bs-target="#collapseHeaders" aria-expanded="false" aria-controls="collapseHeaders">
                    Ver lista
                </button>
            </div>
            <div class="collapse mt-3" id="collapseHeaders">
                <small class="text-muted">Encabezados requeridos en la primera fila:</small>
                <div class="row mt-2">
                    <div class="col-md-6">
                        <ul class="list-unstyled small">
                            <li>• Hora</li>
                            <li>• Usuario</li>
                            <li>• Páginas</li>
                            <li>• Copias</li>
                            <li>• Impresora</li>
                            <li>• Nombre Documento</li>
                            <li>• Cliente</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <ul class="list-unstyled small">
                            <li>• Formato Papel</li>
                            <li>• Idioma</li>
                            <li>• Altura</li>
                            <li>• Anchura</li>
                            <li>• Frente/reverso</li>
                            <li>• Escala de grises</li>
                            <li>• Formato</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contenedor de mensajes flash mejorado -->
        <div id="flashMessages" class="flash-messages-container">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show flash-message" data-auto-dismiss="true">
                            <i class="bi bi-{{ 'exclamation-triangle' if category == 'error' else 'check-circle' if category == 'success' else 'info-circle' }} me-2"></i>
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
        </div>
        
        <!-- Formulario -->
        <form id="uploadForm" method="POST" action="{{ url_for('subir_csv') }}" enctype="multipart/form-data">
            <!-- Zona de arrastrar y soltar -->
            <div class="file-drop-zone mb-3" id="dropZone">
                <i class="bi bi-cloud-upload fs-1"></i>
                <p class="mb-2">Arrastra tu archivo CSV aquí o haz clic para seleccionar</p>
                <input class="form-control d-none" type="file" id="archivo" name="archivo" accept=".csv" required>
            </div>

            <!-- Información del archivo seleccionado -->
            <div id="fileInfo" class="file-info-display d-none">
                <div class="d-flex align-items-center">
                    <i class="bi bi-file-earmark-text me-2"></i>
                    <div class="flex-grow-1">
                        <strong id="fileName"></strong><br>
                        <small id="fileSize" class="text-muted"></small>
                    </div>
                    <button type="button" class="btn-remove-file" id="removeFile">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
            </div>

            <!-- Barra de progreso -->
            <div class="progress-container">
                <div class="progress mb-3">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                </div>
            </div>

            <!-- Botón de envío -->
            <button type="submit" class="btn btn-primary w-100 mb-2" id="submitBtn">
                <i class="bi bi-file-earmark-arrow-up me-1"></i>
                <span class="button-text">Generar reporte de impresiones</span>
                <span class="spinner-border spinner-border-sm ms-2" role="status" style="display: none;"></span>
            </button>
        </form>

        
        <!-- Botón de logout -->
        <button type="button" class="btn btn-danger w-100" id="logoutBtn">
            <i class="bi bi-box-arrow-right me-1"></i>
            <span class="logout-text">Cerrar sesión</span>
            <span class="spinner-border spinner-border-sm ms-2" role="status" style="display: none;"></span>
        </button>
    </div>

    <script>
        // Variables globales
        const uploadForm = document.getElementById('uploadForm');
        const fileInput = document.getElementById('archivo');
        const dropZone = document.getElementById('dropZone');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const removeFileBtn = document.getElementById('removeFile');
        const submitBtn = document.getElementById('submitBtn');
        const progressContainer = document.querySelector('.progress-container');
        const progressBar = document.querySelector('.progress-bar');
        const logoutBtn = document.getElementById('logoutBtn');

        // Variables para control de progreso
        let progressInterval = null;
        let safetyTimeout = null;
        let formSubmitted = false;

        // Clase para manejar mensajes flash
        class FlashMessagesManager {
            constructor() {
                this.container = document.getElementById('flashMessages');
                this.initializeExistingMessages();
            }

            // Inicializar mensajes existentes del servidor
            initializeExistingMessages() {
                const existingMessages = this.container.querySelectorAll('.flash-message[data-auto-dismiss="true"]');
                existingMessages.forEach(message => {
                    this.setupAutoDismiss(message);
                });
            }

            // Crear nuevo mensaje
            create(message, type = 'info', autoDismiss = true) {
                // Limpiar mensajes anteriores del mismo tipo si es necesario
                this.clearByType(type);

                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${type} alert-dismissible fade show flash-message`;
                alertDiv.setAttribute('data-type', type);
                if (autoDismiss) {
                    alertDiv.setAttribute('data-auto-dismiss', 'true');
                }

                const iconClass = this.getIconClass(type);
                alertDiv.innerHTML = `
                    <i class="bi bi-${iconClass} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;

                this.container.appendChild(alertDiv);

                // Configurar auto-dismiss
                if (autoDismiss) {
                    this.setupAutoDismiss(alertDiv);
                }

                // Animar entrada
                setTimeout(() => {
                    alertDiv.classList.add('show');
                }, 10);

                return alertDiv;
            }

            // Obtener clase de icono según el tipo
            getIconClass(type) {
                const icons = {
                    'success': 'check-circle',
                    'danger': 'exclamation-triangle',
                    'warning': 'exclamation-triangle',
                    'info': 'info-circle'
                };
                return icons[type] || 'info-circle';
            }

            // Configurar auto-dismiss para un mensaje
            setupAutoDismiss(alertElement, delay = 5000) {
                const timer = setTimeout(() => {
                    this.dismiss(alertElement);
                }, delay);

                // Pausar el timer al hacer hover
                alertElement.addEventListener('mouseenter', () => {
                    clearTimeout(timer);
                });

                // Reanudar el timer al salir del hover
                alertElement.addEventListener('mouseleave', () => {
                    setTimeout(() => {
                        this.dismiss(alertElement);
                    }, 2000);
                });
            }

            // Descartar mensaje
            dismiss(alertElement) {
                if (alertElement && alertElement.parentNode) {
                    alertElement.classList.remove('show');
                    setTimeout(() => {
                        if (alertElement.parentNode) {
                            alertElement.remove();
                        }
                    }, 150);
                }
            }

            // Limpiar mensajes por tipo
            clearByType(type) {
                const messages = this.container.querySelectorAll(`[data-type="${type}"]`);
                messages.forEach(message => this.dismiss(message));
            }

            // Limpiar todos los mensajes
            clearAll() {
                const messages = this.container.querySelectorAll('.flash-message');
                messages.forEach(message => this.dismiss(message));
            }
        }

        // Inicializar gestor de mensajes
        const flashManager = new FlashMessagesManager();

        // Función para mostrar mensajes (ahora usa el gestor)
        function showMessage(message, type = 'info', autoDismiss = true) {
            return flashManager.create(message, type, autoDismiss);
        }

        // Función para formatear el tamaño del archivo
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Función para validar archivo CSV
        function validateCSVFile(file) {
            if (!file.name.toLowerCase().endsWith('.csv')) {
                showMessage('Por favor selecciona un archivo CSV válido (.csv)', 'danger');
                return false;
            }
            
            const maxSize = 16 * 1024 * 1024; // 16MB
            if (file.size > maxSize) {
                showMessage('El archivo es demasiado grande. Tamaño máximo permitido: 16MB', 'danger');
                return false;
            }
            
            return true;
        }

        // Función para mostrar información del archivo
        function showFileInfo(file) {
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            fileInfo.classList.remove('d-none');
            dropZone.style.display = 'none';
        }

        // Función para ocultar información del archivo
        function hideFileInfo() {
            fileInfo.classList.add('d-none');
            dropZone.style.display = 'block';
            fileInput.value = '';
            
            // Limpiar mensajes de éxito
            flashManager.clearByType('success');
        }

        // Event listeners para drag and drop
        dropZone.addEventListener('click', () => fileInput.click());

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                if (validateCSVFile(file)) {
                    fileInput.files = files;
                    showFileInfo(file);
                }
            }
        });

        // Event listener para input de archivo
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                if (validateCSVFile(file)) {
                    showFileInfo(file);
                } else {
                    e.target.value = '';
                }
            }
        });

        // Event listener para remover archivo
        removeFileBtn.addEventListener('click', hideFileInfo);

        // Event listener para envío del formulario
        uploadForm.addEventListener('submit', (e) => {
            e.preventDefault(); // Siempre prevenir envío normal
            
            const file = fileInput.files[0];
            if (!file) {
                showMessage('Por favor selecciona un archivo CSV', 'danger');
                return;
            }

            // Marcar que el formulario fue enviado
            formSubmitted = true;
            
            // Mostrar estado de carga
            showLoadingState();
            
            // Mostrar barra de progreso
            progressContainer.style.display = 'block';
            
            // Iniciar simulación de progreso
            startProgressSimulation();
            
            // Enviar formulario con AJAX
            submitFormWithAjax();
        });

        // Función para mostrar estado de carga
        function showLoadingState() {
            const spinner = submitBtn.querySelector('.spinner-border');
            const buttonText = submitBtn.querySelector('.button-text');
            
            spinner.style.display = 'inline-block';
            buttonText.textContent = 'Procesando archivo...';
            submitBtn.disabled = true;
        }

        // Función para ocultar estado de carga
        function hideLoadingState() {
            const spinner = submitBtn.querySelector('.spinner-border');
            const buttonText = submitBtn.querySelector('.button-text');
            
            spinner.style.display = 'none';
            buttonText.textContent = 'Generar reporte de impresiones';
            submitBtn.disabled = false;
            progressContainer.style.display = 'none';
            progressBar.style.width = '0%';
            
            // Limpiar intervalos y timeouts
            clearProgressTimers();
        }

        // Función para limpiar timers de progreso
        function clearProgressTimers() {
            if (progressInterval) {
                clearInterval(progressInterval);
                progressInterval = null;
            }
            if (safetyTimeout) {
                clearTimeout(safetyTimeout);
                safetyTimeout = null;
            }
        }

        // Función para iniciar simulación de progreso mejorada
        function startProgressSimulation() {
            let progress = 0;
            let currentPhase = 0;
            
            const phases = [
                { end: 15, message: 'Validando archivo...', speed: 2 },
                { end: 35, message: 'Leyendo datos CSV...', speed: 1.5 },
                { end: 60, message: 'Procesando información...', speed: 1 },
                { end: 85, message: 'Generando reporte Excel...', speed: 1.2 },
                { end: 95, message: 'Finalizando proceso...', speed: 0.5 }
            ];
            
            const buttonText = submitBtn.querySelector('.button-text');
            
            progressInterval = setInterval(() => {
                if (currentPhase < phases.length) {
                    const phase = phases[currentPhase];
                    
                    // Incrementar progreso gradualmente
                    const increment = phase.speed;
                    progress = Math.min(progress + increment, phase.end);
                    
                    // Actualizar mensaje si es necesario
                    if (Math.floor(progress) >= phase.end - 2) {
                        buttonText.textContent = phase.message;
                        if (progress >= phase.end) {
                            currentPhase++;
                        }
                    }
                } else {
                    // Fase final - mantener en 95% hasta que termine el servidor
                    progress = Math.min(progress + 0.1, 98);
                }
                
                progressBar.style.width = progress + '%';
                
            }, 300);

            // Timeout de seguridad más largo - solo se ejecuta si el formulario no se procesa
            safetyTimeout = setTimeout(() => {
                if (formSubmitted && submitBtn.disabled) {
                    clearProgressTimers();
                    hideLoadingState();
                    showMessage('El proceso está tomando más tiempo del esperado. Por favor, verifica tu conexión e intenta nuevamente.', 'warning');
                    formSubmitted = false;
                }
            }, 45000); // 45 segundos
        }

        // Event listener para botón de logout
        logoutBtn.addEventListener('click', (e) => {
            e.preventDefault();
            
            if (confirm('¿Estás seguro de que deseas cerrar sesión?')) {
                const spinner = logoutBtn.querySelector('.spinner-border');
                const logoutText = logoutBtn.querySelector('.logout-text');
                
                spinner.style.display = 'inline-block';
                logoutText.textContent = 'Cerrando sesión...';
                logoutBtn.disabled = true;
                
                setTimeout(() => {
                    window.location.href = "/logout";
                }, 1000);
            }
        });

        // Función para enviar formulario con AJAX
        function submitFormWithAjax() {
            const formData = new FormData(uploadForm);
            
            fetch('/subir_csv', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    // Verificar si es una descarga de archivo
                    const contentType = response.headers.get('content-type');
                    const contentDisposition = response.headers.get('content-disposition');
                    
                    if (contentDisposition && contentDisposition.includes('attachment')) {
                        // Es una descarga de archivo - proceso exitoso
                        return response.blob().then(blob => {
                            // Completar progreso
                            completeProgress();
                            
                            // Descargar archivo
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = extractFilenameFromHeader(contentDisposition) || 'reporte_impresiones.xlsx';
                            document.body.appendChild(a);
                            a.click();
                            window.URL.revokeObjectURL(url);
                            document.body.removeChild(a);
                            
                            // Mostrar mensaje de éxito
                            showMessage('¡Reporte generado y descargado exitosamente!', 'success');
                            
                            // Resetear formulario después de un momento
                            setTimeout(() => {
                                resetForm();
                            }, 2000);
                        });
                    } else {
                        // Es una respuesta HTML - verificar si hay errores o éxito
                        return response.text().then(html => {
                            // Verificar si hay mensajes de error sobre encabezados
                            if (html.includes('alert-danger') || html.includes('encabezados') || 
                                html.includes('columnas') || html.includes('formato incorrecto') ||
                                html.includes('headers') || html.includes('CSV inválido')) {
                                
                                // Extraer el mensaje de error del HTML
                                const errorMessage = extractErrorMessage(html);
                                handleProcessingError(errorMessage || 'El archivo CSV no tiene el formato correcto. Verifica que contenga todos los encabezados requeridos.');
                                
                            } else if (html.includes('alert-success') || html.includes('Reporte generado')) {
                                // Proceso exitoso pero sin descarga directa
                                completeProgress();
                                showMessage('¡Reporte generado exitosamente!', 'success');
                                setTimeout(() => {
                                    resetForm();
                                }, 2000);
                                
                            } else {
                                // Respuesta inesperada - podría ser redirección
                                window.location.reload();
                            }
                        });
                    }
                } else {
                    // Error HTTP del servidor
                    return response.text().then(text => {
                        let errorMessage = 'Error del servidor';
                        
                        // Intentar extraer mensaje de error más específico
                        if (response.status === 400) {
                            errorMessage = 'Archivo CSV inválido o formato incorrecto';
                        } else if (response.status === 413) {
                            errorMessage = 'El archivo es demasiado grande';
                        } else if (response.status === 422) {
                            errorMessage = 'El archivo CSV no contiene los encabezados requeridos';
                        } else if (response.status >= 500) {
                            errorMessage = 'Error interno del servidor. Intenta nuevamente.';
                        }
                        
                        handleProcessingError(errorMessage);
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                let errorMessage = 'Error de conexión. Verifica tu conexión a internet e intenta nuevamente.';
                
                if (error.name === 'TypeError') {
                    errorMessage = 'No se pudo conectar con el servidor. Verifica tu conexión.';
                } else if (error.message.includes('timeout')) {
                    errorMessage = 'La conexión tardó demasiado tiempo. Intenta con un archivo más pequeño.';
                }
                
                handleProcessingError(errorMessage);
            });
        }
        
        // Función para extraer mensaje de error del HTML
        function extractErrorMessage(html) {
            try {
                // Crear un parser temporal para extraer el mensaje
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                // Buscar alerts de error
                const errorAlert = doc.querySelector('.alert-danger');
                if (errorAlert) {
                    // Extraer solo el texto, sin íconos
                    let message = errorAlert.textContent || errorAlert.innerText || '';
                    message = message.replace(/^\s*[×✕]\s*/, '').trim(); // Remover botones de cerrar
                    return message;
                }
                
                return null;
            } catch (e) {
                return null;
            }
        }
        
        // Función para manejar errores de procesamiento
        function handleProcessingError(errorMessage) {
            clearProgressTimers();
            hideLoadingState();
            
            // Mostrar mensaje de error específico
            showMessage(errorMessage, 'danger', false); // No auto-dismiss para errores importantes
            
            // Mostrar la lista de encabezados requeridos si es error de formato
            if (errorMessage.toLowerCase().includes('encabezados') || 
                errorMessage.toLowerCase().includes('formato') ||
                errorMessage.toLowerCase().includes('columnas')) {
                
                // Expandir automáticamente la lista de encabezados
                const collapseElement = document.getElementById('collapseHeaders');
                if (collapseElement && !collapseElement.classList.contains('show')) {
                    const bsCollapse = new bootstrap.Collapse(collapseElement, {
                        show: true
                    });
                }
            }
            
            formSubmitted = false;
        }

        // Función para extraer nombre de archivo del header
        function extractFilenameFromHeader(contentDisposition) {
            const filenameMatch = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
            if (filenameMatch && filenameMatch[1]) {
                return filenameMatch[1].replace(/['"]/g, '');
            }
            return null;
        }

        // Función para completar el progreso
        function completeProgress() {
            clearProgressTimers();
            
            // Completar progreso al 100%
            progressBar.style.width = '100%';
            const buttonText = submitBtn.querySelector('.button-text');
            buttonText.textContent = '¡Proceso completado!';
            
            // Ocultar después de un momento
            setTimeout(() => {
                hideLoadingState();
            }, 1500);
        }

        // Función para resetear el formulario
        function resetForm() {
            hideFileInfo();
            formSubmitted = false;
            flashManager.clearByType('success');
        }

        // Detectar cuando la página se recarga o cambia (procesamiento exitoso)
        window.addEventListener('beforeunload', () => {
            clearProgressTimers();
        });

        // Detectar cuando la página se oculta (navegación exitosa)
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                clearProgressTimers();
            }
        });
        window.addEventListener('dragover', (e) => e.preventDefault());
        window.addEventListener('drop', (e) => e.preventDefault());

        // Manejar eventos de teclado para accesibilidad
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                flashManager.clearAll();
            }
        });
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>